---
title: "Data Exploration"
author: "Jay"
date: "June 10, 2016"
output: html_document
---

```{r}
devtools::install_github("hadley/assertthat")
devtools::install_github("rstats-db/bigrquery")

library(bigrquery)
library(curl)
library(corrplot)
library(Cairo)
library(ggplot2)
```

```{r}
setwd("C:\\Dropbox\\Projects\\kaggle\\datalab-projects\\Xiaojukeji Algorithm Competition\\R")

if (file.exists('data.Rda')) {
  load("data.Rda")
} else {
  project <- "datalab-projects-1331" # put your projectID here
 
  sql <- 'SELECT * FROM[datalab-projects-1331:xjk_algo_comp.future_gaps_processed];'
   
  data <- query_exec(sql, project=project, max_pages=Inf)
  save(data,file="data.Rda")
}
data[is.na(data)] <- 0
```

# Corrplot
```{r}
data1 <- data[ , !names(data) %in% c("timeslot", "date")]
cors <- cor(data1)
corrplot(cors, method="color", order="hclust", tl.cex = 0.8)
```

Clearer version is available at file `corrplot.png` (4000px width).

From there we see that `gap` is only strongly correlated with `sum_price`.

# Which days in week have different gaps?
```{r}
ggplot(aes(y=gap, x=as.factor(day_in_week)), data=data) +
  geom_boxplot() +
  scale_y_log10()
```

Looks like there is usually less gap on Sunday. Variable `is_sunday` may need to be created.

```{r}
data$is_sunday <- ifelse(data$day_in_week == 0, TRUE, FALSE)
cor1 <- cor(x=data$is_sunday, y=data$gap)
cor2 <- cor(x=data$sum_price, y=data$gap)
cor3 <- cor(x=data$f1, y=data$gap)
print(paste("correlation between is_sunday and gap: ", cor1, sep=" "))
print(paste("correlation between sum_price and gap: ", cor2, sep=" "))
print(paste("correlation between f1 and gap: ", cor3, sep=" "))
```

```{r}
cors <- cor(x=data$gap, y=data1)
corsdf <- as.data.frame(as.table(cors))
corsdf=corsdf[order(-abs(corsdf$Freq)),] 
```

# Traffic
How do gaps differ on different traffic levels?

```{r}
ggplot(aes(y=gap, x=traffic_tj_level1), data=data) +
  geom_jitter(alpha=0.4) +
  geom_smooth()
```

After 3500 `traffic_tj_level1` some high gaps are starting to show, but their numbers are insignificant compared to the entire general trend.

Let's see if log scaling `gap` variable will unravel more information.

```{r}
ggplot(aes(y=gap, x=traffic_tj_level1), data=data) +
  geom_jitter(alpha=0.4) +
  scale_y_log10() +
  geom_smooth()
```
